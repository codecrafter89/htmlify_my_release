<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>HTMLify My Release Enhanced - By CodeCrafter89</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #007aff;
            --secondary-color: #5856d6;
            --success-color: #34c759;
            --danger-color: #ff3b30;
            --warning-color: #ff9500;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-tertiary: #fafafa;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --border-color: #d2d2d7;
            --shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 4px 24px rgba(0, 0, 0, 0.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 1400px; }

        .navbar {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: saturate(180%) blur(20px);
            border: none !important;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem !important;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .navbar-brand { color: var(--text-primary) !important; font-weight: 600 !important; font-size: 1.5rem !important; letter-spacing: -0.5px; }
        .navbar-brand i { color: var(--primary-color); animation: pulse 2s ease-in-out infinite; }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .btn-outline-success {
            border: 1.5px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            position: relative;
            overflow: hidden;
        }

        .btn-outline-success:hover { border-color: var(--primary-color); color: white; background: var(--primary-color); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); }

        .step-indicator { margin: 3rem 0; padding: 0; display: flex; justify-content: center; gap: 2rem; animation: fadeInUp 0.8s ease-out 0.4s both; }

        .step { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; position: relative; transition: all 0.3s ease; }

        .step::after { content: ''; position: absolute; top: 25px; left: 60%; width: 100%; height: 2px; background: var(--border-color); z-index: -1; transition: all 0.5s ease; }
        .step.completed::after { background: linear-gradient(90deg, var(--success-color), var(--primary-color)); }
        .step:last-child::after { display: none; }

        .step-number { width: 50px; height: 50px; background: white; border: 2px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); font-size: 1.25rem; color: var(--text-secondary); }

        .step.active .step-number { background: var(--primary-color); border-color: var(--primary-color); color: white; transform: scale(1.15); box-shadow: 0 0 20px rgba(0, 122, 255, 0.5); }
        .step.completed .step-number { background: var(--success-color); border-color: var(--success-color); color: white; }

        .step span { color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; transition: all 0.3s ease; }
        .step.active span, .step.completed span { color: var(--text-primary); font-weight: 600; }

        .card { background: white !important; border: 1px solid var(--border-color) !important; border-radius: 1rem !important; box-shadow: var(--shadow); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .card:hover { box-shadow: var(--shadow-hover); transform: translateY(-4px); }

        .card-header { background: var(--bg-tertiary) !important; border-bottom: 1px solid var(--border-color) !important; border-radius: 1rem 1rem 0 0 !important; padding: 1.25rem 1.5rem !important; font-weight: 600; color: var(--text-primary) !important; }
        .card-body { padding: 2rem; }
        .card-title { color: var(--text-primary); font-weight: 600; font-size: 1.25rem; margin-bottom: 1.5rem; }
        .card-title i { color: var(--primary-color); }

        .form-label { color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem; font-size: 0.95rem; }
        .form-control, .form-select { background: white !important; border: 1.5px solid var(--border-color) !important; color: var(--text-primary) !important; border-radius: 0.75rem; padding: 0.75rem 1rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 1rem; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color) !important; box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1) !important; outline: none; transform: translateY(-2px); }

        .btn { border-radius: 0.75rem; padding: 0.75rem 1.5rem; font-weight: 500; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: none; font-size: 1rem; position: relative; overflow: hidden; }
        .btn-success { background: var(--primary-color); color: white; box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2); }
        .btn-success:hover { background: #0051d5; transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3); }
        .btn-outline-secondary { border: 1.5px solid var(--border-color); color: var(--text-primary); background: white; }
        .btn-outline-secondary:hover { background: var(--bg-tertiary); border-color: var(--text-secondary); transform: translateY(-2px); }
        .btn-outline-primary { border: 1.5px solid var(--primary-color); color: var(--primary-color); background: white; }
        .btn-outline-primary:hover { background: var(--primary-color); color: white; transform: translateY(-2px); }
        .btn-outline-danger { border: 1.5px solid var(--danger-color); color: var(--danger-color); background: white; }
        .btn-outline-danger:hover { background: var(--danger-color); color: white; transform: translateY(-2px); }

        .editable-grid { max-height: 700px; overflow-y: auto; overflow-x: auto; border-radius: 0.75rem; border: 1px solid var(--border-color); background: white; }
        .editable-grid::-webkit-scrollbar { width: 12px; height: 12px; }
        .editable-grid::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        .editable-grid::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 6px; }
        .editable-grid::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        .table { color: var(--text-primary); margin-bottom: 0; }
        .table thead th { background: var(--bg-tertiary); color: var(--text-primary); font-weight: 600; border: none; padding: 1rem; font-size: 0.9rem; position: sticky; top: 0; z-index: 10; }
        .table tbody tr { border-bottom: 1px solid var(--border-color); transition: all 0.3s ease; }
        .table tbody tr:hover { background: var(--bg-tertiary); }
        .table tbody td { padding: 0.75rem; vertical-align: middle; border: none; }
        .table .form-control, .table .form-select, .table textarea { background: white !important; border: 1px solid var(--border-color) !important; font-size: 0.9rem; padding: 0.5rem; }

        .grid-actions { background: var(--bg-tertiary); padding: 1rem; border-bottom: 1px solid var(--border-color); border-radius: 0.75rem 0.75rem 0 0; margin-bottom: 0; }

        .status-new { color: var(--success-color); font-weight: 600; }
        .status-modified { color: var(--warning-color); font-weight: 600; }
        .status-existing { color: var(--primary-color); font-weight: 600; }
        .status-deprecated { color: var(--danger-color); font-weight: 600; }

        #preview, #output { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; }
        pre.code { font-family: 'SF Mono', Monaco, 'Courier New', monospace; background: var(--bg-tertiary) !important; color: var(--text-primary); font-size: 0.9rem; line-height: 1.6; }

        footer { background: white; border-top: 1px solid var(--border-color); color: var(--text-secondary); margin-top: 4rem; }

        .modal-content { background: white; border: 1px solid var(--border-color); border-radius: 1rem; color: var(--text-primary); }
        .modal-header { background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); padding: 1.5rem; border-radius: 1rem 1rem 0 0; }
        .modal-title { color: var(--text-primary); font-weight: 600; }
        .modal-body { background: white; padding: 1.5rem; }
        .modal-footer { background: var(--bg-tertiary); border-top: 1px solid var(--border-color); padding: 1rem 1.5rem; border-radius: 0 0 1rem 1rem; }

        .accordion-item { background: white; border: 1px solid var(--border-color); color: var(--text-primary); margin-bottom: 0.5rem; border-radius: 0.5rem !important; transition: all 0.3s ease; }
        .accordion-button { background: white; color: var(--text-primary); border: none; font-weight: 500; }
        .accordion-button:not(.collapsed) { background: var(--bg-tertiary); color: var(--text-primary); box-shadow: none; }
        .accordion-button:focus { box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1); border-color: var(--primary-color); }
        .accordion-body { background: white; color: var(--text-primary); }
        .accordion-body code { background: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 0.25rem; color: var(--secondary-color); font-size: 0.9em; }

        .alert-info { background: rgba(0, 122, 255, 0.1); border: 1px solid var(--primary-color); color: var(--text-primary); border-radius: 0.75rem; }

        .card.border-primary { border-color: var(--primary-color) !important; }
        .card.border-primary .card-header { background: var(--primary-color) !important; color: white !important; }
        .card.border-success { border-color: var(--success-color) !important; }
        .card.border-success .card-header { background: var(--success-color) !important; color: white !important; }
        .card.border-warning { border-color: var(--warning-color) !important; }
        .card.border-warning .card-header { background: var(--warning-color) !important; color: white !important; }
        .card.border-info { border-color: #00c7be !important; }
        .card.border-info .card-header { background: #00c7be !important; color: white !important; }

        .text-success { color: var(--success-color) !important; }
        .text-danger { color: var(--danger-color) !important; }
        .text-muted { color: var(--text-secondary) !important; }

        .form-check-input { background-color: white; border: 1.5px solid var(--border-color); width: 1.25rem; height: 1.25rem; transition: all 0.3s ease; }
        .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
        .form-check-input:focus { box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1); border-color: var(--primary-color); }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .loading::after { content: ''; display: inline-block; width: 12px; height: 12px; margin-left: 8px; border: 2px solid var(--primary-color); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) { .step-indicator { flex-direction: column; gap: 1rem; } .step::after { display: none; } .step { flex-direction: row; justify-content: flex-start; } .navbar { padding: 1rem !important; } .card-body { padding: 1.5rem; } }

        .step-section { display: none; }
        .step-section.active { display: block; animation: fadeInUp 0.5s ease-out; }

        .hint-badge { display: inline-block; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; margin-left: 0.5rem; cursor: help; }
        .hint-badge:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(88, 86, 214, 0.4); }
    </style>
</head>

<body>
    <div class="container pt-3">
        <nav class="navbar navbar-light bg-white border rounded shadow-sm mb-4 py-3 px-4">
            <b>
                <span class="navbar-brand mb-0 d-flex align-items-center">
                    <i class="bi bi-code-slash me-2" style="font-size: 1.8rem;"></i>
                    HTMLify My Release Enhanced
                </span>
            </b>
            <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="bi bi-question-circle me-1"></i> Help
            </button>
        </nav>

        <div class="step-indicator">
            <div class="step active" id="step1-indicator">
                <div class="step-number"><i class="bi bi-upload"></i></div>
                <span>Upload File</span>
            </div>
            <div class="step" id="step2-indicator">
                <div class="step-number"><i class="bi bi-pencil-square"></i></div>
                <span>Edit Components</span>
            </div>
            <div class="step" id="step3-indicator">
                <div class="step-number"><i class="bi bi-file-code"></i></div>
                <span>Generate Output</span>
            </div>
        </div>

        <!-- Step 1 -->
        <div id="step1" class="step-section active">
            <div class="card border-0 shadow-sm rounded-3 mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-cloud-upload me-2"></i> Upload Excel File
                        <span class="hint-badge">‚ú® Drag & drop works too!</span>
                    </h5>
                    <div class="row g-3 align-items">
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-file-earmark-excel me-1"></i> Excel File (.xlsx / .xls)</label>
                            <input type="file" id="fileInput" class="form-control" accept=".xlsx,.xls" />
                            <small class="text-muted">üí° Exported from XrmToolBox? Perfect!</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-grid-3x3-gap me-1"></i> Solution Cell (optional)</label>
                            <input type="text" id="solutionCell" class="form-control" value="B1" placeholder="e.g., B1 or C2" />
                            <small class="text-muted">üìç Where's your solution name?</small>
                        </div>
                        <div class="col-md-3 d-grid">
                            <label class="form-label"></label>
                            <button id="loadBtn" class="btn btn-success btn-lg">
                                <i class="bi bi-arrow-right-circle me-1"></i> Load File
                            </button>
                        </div>
                    </div>
                    <div class="mt-3"><span id="loadStatus" class="small"></span></div>
                </div>
            </div>
        </div>

        <!-- Step 2 -->
        <div id="step2" class="step-section">
            <div class="card border-0 shadow-sm rounded-3 mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-grid-3x3-gap-fill me-2"></i> Edit Component Details
                        <span class="hint-badge">üé® Click any cell to edit</span>
                    </h5>
                    <div class="grid-actions">
                        <div class="d-flex gap-2 flex-wrap align-items-center">
                            <button id="addRowBtn" class="btn btn-sm btn-outline-success"><i class="bi bi-plus-circle me-1"></i> Add Row</button>
                            <button id="removeSelectedBtn" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash me-1"></i> Remove Selected</button>
                            <div class="ms-auto"><span id="rowCount" class="small"></span></div>
                        </div>
                    </div>
                    <div class="editable-grid">
                        <table class="table table-bordered table-hover" id="componentGrid">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                                    <th>Component Type</th>
                                    <th>Related Table/Entity</th>
                                    <th>Display Name</th>
                                    <th>Name</th>
                                    <th style="width: 200px;">Component Status</th>
                                    <th style="width: 350px;">Description</th>
                                </tr>
                            </thead>
                            <tbody id="gridBody"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 d-flex gap-2">
                        <button id="backToUploadBtn" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i> Back</button>
                        <button id="proceedToGenerateBtn" class="btn btn-success ms-auto">Proceed to Generate <i class="bi bi-arrow-right-circle ms-1"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3 -->
        <div id="step3" class="step-section">
            <div class="card border-0 shadow-sm rounded-3 mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-file-earmark-code me-2"></i> Generate HTML Output
                        <span class="hint-badge">üöÄ Ready to ship!</span>
                    </h5>
                    <div class="d-flex gap-2 mb-3 flex-wrap">
                        <button id="generateBtn" class="btn btn-success"><i class="bi bi-gear-fill me-1"></i> Generate HTML</button>
                        <button id="copyBtn" class="btn btn-outline-warning" disabled style="display: none;"><i class="bi bi-clipboard me-1"></i> Copy HTML</button>
                        <button id="downloadBtn" class="btn btn-outline-primary" disabled style="display: none;"><i class="bi bi-download me-1"></i> Download HTML</button>
                        <button id="backToEditBtn" class="btn btn-outline-info ms-auto"><i class="bi bi-arrow-left me-1"></i> Back to Edit</button>
                    </div>
                    <div class="mb-3"><span id="generateStatus" class="small"></span></div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 rounded-3 h-100">
                        <div class="card-header py-3"><i class="bi bi-eye me-2"></i> Rendered Preview <span class="hint-badge">üëÄ See it live</span></div>
                        <div class="card-body"><div id="preview" style="min-height: 400px;"></div></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 rounded-3 h-100">
                        <div class="card-header text-white py-3" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;">
                            <i class="bi bi-code-slash me-2"></i> Generated HTML (Raw)
                            <span class="hint-badge" style="background: rgba(255,255,255,0.2);">üìã Copy ready</span>
                        </div>
                        <div class="card-body"><pre id="output" class="code" style="min-height: 350px;"></pre></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel"><i class="bi bi-info-circle me-2"></i> User Guide & Supported Components</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-success fw-bold mb-3"><i class="bi bi-list-check"></i> How to Use This Tool</h6>
                    <div class="accordion accordion-flush mb-4" id="guidelinesAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#solutionExtractionGuide">
                                    <i class="bi bi-1-circle-fill text-success me-2"></i> Step 1: Solution Component Extraction
                                </button>
                            </h2>
                            <div id="solutionExtractionGuide" class="accordion-collapse collapse show" data-bs-parent="#guidelinesAccordion">
                                <div class="accordion-body">
                                    <ul class="small">
                                        <li><strong>Install Solution Component Extractor</strong> from XrmToolBox Tool Library</li>
                                        <li class="mt-2"><strong>Search Using Solution Unique Name</strong> (not display name)</li>
                                        <li class="mt-2"><strong>Export Components to Excel</strong> ‚Äî do not modify sheet name or column structure</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1Guide">
                                    <i class="bi bi-2-circle-fill text-success me-2"></i> Step 2: Upload Excel File
                                </button>
                            </h2>
                            <div id="step1Guide" class="accordion-collapse collapse" data-bs-parent="#guidelinesAccordion">
                                <div class="accordion-body">
                                    <ul class="small">
                                        <li>Select an Excel file (.xlsx or .xls)</li>
                                        <li>Headers expected: <code>Component Type</code>, <code>Display Name</code>, <code>Name</code>, <code>Related Table</code></li>
                                        <li>Optionally specify cell containing solution name</li>
                                        <li>Click <strong>Load File</strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2Guide">
                                    <i class="bi bi-3-circle-fill text-success me-2"></i> Step 3: Edit Component Details
                                </button>
                            </h2>
                            <div id="step2Guide" class="accordion-collapse collapse" data-bs-parent="#guidelinesAccordion">
                                <div class="accordion-body">
                                    <ul class="small">
                                        <li>Review all loaded components in the editable grid</li>
                                        <li><strong>Component Status:</strong> New, Modified, Existing, or Deprecated</li>
                                        <li><strong>Description:</strong> Add notes explaining changes</li>
                                        <li>Add/Remove rows as needed</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3Guide">
                                    <i class="bi bi-4-circle-fill text-success me-2"></i> Step 4: Generate HTML Output
                                </button>
                            </h2>
                            <div id="step3Guide" class="accordion-collapse collapse" data-bs-parent="#guidelinesAccordion">
                                <div class="accordion-body">
                                    <ul class="small">
                                        <li>Click <strong>Generate HTML</strong></li>
                                        <li>View rendered preview or copy/download raw HTML</li>
                                        <li>Status badges are color-coded (New=Green, Modified=Yellow, Existing=Blue, Deprecated=Red)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <h6 class="text-success fw-bold mb-3"><i class="bi bi-box-seam"></i> Supported Components</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white py-2"><small class="fw-bold"><i class="bi bi-database"></i> Dynamics 365 / Dataverse (Entity-level)</small></div>
                                <div class="card-body p-2">
                                    <ul class="small mb-0" style="font-size: 0.8rem;">
                                        <li>Tables (Entities)</li>
                                        <li>Columns / Fields / Attributes</li>
                                        <li>Forms (Main, Quick Create, Quick View)</li>
                                        <li>Views</li>
                                        <li>Charts</li>
                                        <li>Keys</li>
                                        <li>Relationships (1:N, N:1, N:N)</li>
                                        <li>Business Rules</li>
                                        <li>Hierarchy Settings</li>
                                        <li>Dashboards</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white py-2"><small class="fw-bold"><i class="bi bi-lightning-charge"></i> Power Platform & Global</small></div>
                                <div class="card-body p-2">
                                    <ul class="small mb-0" style="font-size: 0.8rem;">
                                        <li>Canvas Apps</li>
                                        <li>Model-Driven Apps</li>
                                        <li>Cloud Flows (Power Automate)</li>
                                        <li>Connection References</li>
                                        <li>Environment Variable Definitions</li>
                                        <li>Custom Controls (PCF)</li>
                                        <li>Business Process Flows</li>
                                        <li>Option Sets / Choices (Global)</li>
                                        <li>Security Roles</li>
                                        <li>Sitemaps</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark py-2"><small class="fw-bold"><i class="bi bi-code-square"></i> Development</small></div>
                                <div class="card-body p-2">
                                    <ul class="small mb-0" style="font-size: 0.8rem;">
                                        <li>Plugin Assemblies</li>
                                        <li>Plugin Steps (SDK Message Processing Steps)</li>
                                        <li>Web Resources (HTML/CSS/JS)</li>
                                        <li>Email Templates</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white py-2"><small class="fw-bold"><i class="bi bi-cloud"></i> Azure</small></div>
                                <div class="card-body p-2">
                                    <ul class="small mb-0" style="font-size: 0.8rem;">
                                        <li>Azure Functions</li>
                                        <li>Azure Logic Apps</li>
                                        <li>Other Azure Resources</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3 mb-0" role="alert">
                        <i class="bi bi-lightbulb"></i> <strong>Tip:</strong> Entity-level components (Forms, Views, Charts, Business Rules, Relationships, Keys, Columns, Hierarchy Settings) are grouped under their parent Table in the output.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-5 py-4">
        <div class="container">
            <p class="mb-1" style="font-size: 0.95rem; color: var(--text-primary);">Release Notes HTML Generator [Enhanced]</p>
            <p class="mb-0 small">&copy; 2025 <strong>CodeCrafter.89</strong> &mdash; Making releases less painful.</p>
        </div>
    </footer>

    <script>
        let componentData = [];
        let solutionName = "";

        const ESC = (s) => String(s ?? "")
            .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        const norm = (s) => String(s ?? "").trim();

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ENTITY-LEVEL component types (grouped under their Related Table/Entity)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const ENTITY_LEVEL_TYPES = new Set([
            "Table", "Column", "Form", "Main Form", "Quick Create Form", "Quick View Form",
            "View", "Chart", "Key", "Relationship", "Business Rule",
            "Hierarchy Setting", "Dashboard (Entity)"
        ]);

        function normalizeType(s) {
            const t = String(s || "").trim().toLowerCase();
            const patterns = [
                // ‚îÄ‚îÄ Entity-level ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                { name: "Table",                    test: v => v === "table" || v === "entity" },
                { name: "Column",                   test: v => v === "column" || v === "field" || v === "attribute" },
                { name: "Main Form",                test: v => v === "main form" || v === "mainform" },
                { name: "Quick Create Form",        test: v => v.includes("quick create") },
                { name: "Quick View Form",          test: v => v.includes("quick view") },
                { name: "Form",                     test: v => v === "form" },
                { name: "View",                     test: v => v === "view" },
                { name: "Chart",                    test: v => v === "chart" || v === "visualization" },
                { name: "Key",                      test: v => v === "key" || v === "alternate key" },
                { name: "Relationship",             test: v => v === "relationship" || v.includes("1:n") || v.includes("n:1") || v.includes("n:n") || v.includes("many-to") || v.includes("one-to") },
                { name: "Business Rule",            test: v => v === "business rule" || v.includes("businessrule") },
                { name: "Hierarchy Setting",        test: v => v.includes("hierarchy") },
                { name: "Dashboard (Entity)",       test: v => v === "dashboard (entity)" },
                // ‚îÄ‚îÄ Global / App-level ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                { name: "Canvas App",               test: v => v === "canvas app" || v.includes("canvas") },
                { name: "Cloud Flow",               test: v => v === "cloud flow" || v === "flow" || v.includes("power automate") },
                { name: "Custom Control",           test: v => v === "custom control" || v.includes("pcf") },
                { name: "Model-Driven App",         test: v => v === "model - driven app" || v === "model-driven app" || v.includes("model driven") || v.includes("model-driven") },
                { name: "Plugin Assembly",          test: v => v === "plugin assembly" || (v.includes("assembly") && !v.includes("plugin step")) },
                { name: "Plugin Step",              test: v => v === "plugin step" || v === "sdk message processing step" || v.includes("sdk message") },
                { name: "Security Role",            test: v => v === "security role" || v === "role" },
                { name: "Web Resource",             test: v => v.startsWith("web resource") || v.includes("webresource") },
                { name: "Environment Variable Definition", test: v => v.includes("environment variable") || v.includes("env var") },
                { name: "Email Template",           test: v => v === "email template" || (v.includes("template") && !v.includes("mail merge")) },
                { name: "Business Process Flow",    test: v => v.includes("bpf") || v.includes("business process flow") },
                { name: "Dashboard",                test: v => v === "dashboard" },
                { name: "Sitemap",                  test: v => v === "sitemap" || v === "site map" },
                { name: "Connection Reference",     test: v => v.includes("connection reference") },
                { name: "Choice",                   test: v => v === "choice" || v === "option set" || v === "optionset" || v === "global option set" },
                { name: "Azure Function",           test: v => v.includes("azure function") || v.includes("function app") },
                { name: "Azure Logic App",          test: v => v.includes("logic app") },
                { name: "Azure Resource",           test: v => v.includes("azure") && !v.includes("function") && !v.includes("logic") },
            ];

            const hit = patterns.find(p => p.test(t));
            return hit ? hit.name : s; // return original if no match (instead of dropping it)
        }

        function getCell(ws, addr) {
            const cell = ws[addr];
            if (!cell) return "";
            return String(cell.v ?? cell.w ?? "");
        }

        function pad(n) { return String(n).padStart(2, "0"); }

        function customDateFormat(d, fmt = "DD/MM/YYYY HH:mm") {
            const DD = pad(d.getDate()), MM = pad(d.getMonth() + 1), YYYY = d.getFullYear();
            const HH = pad(d.getHours()), mm = pad(d.getMinutes()), ss = pad(d.getSeconds());
            return fmt.replace("DD", DD).replace("MM", MM).replace("YYYY", YYYY)
                .replace("HH", HH).replace("mm", mm).replace("ss", ss);
        }

        function formatDate(v, fmt = "DD/MM/YYYY HH:mm") {
            if (!v) return "";
            try {
                if (typeof v === "number") {
                    const dt = XLSX.SSF.parse_date_code(v);
                    const d = new Date(Date.UTC(dt.y, dt.m - 1, dt.d, dt.H, dt.M, dt.S));
                    return customDateFormat(d, fmt);
                }
                const d = new Date(v);
                if (!isNaN(d)) return customDateFormat(d, fmt);
            } catch (e) {}
            return String(v);
        }

        const fuzz = (s) => String(s || "").replace(/^\uFEFF/, "").toLowerCase().replace(/[\s\-_]+/g, " ").trim();

        const HEADER_ALIASES = {
            "solution unique name": ["solution unique name", "solutionuniquename", "solution name", "solution"],
            "related table":        ["related table", "related entity", "entity", "table name", "table"],
            "component type":       ["component type", "componenttype", "type", "component"],
            "display name":         ["display name", "displayname", "label", "friendly name"],
            "name":                 ["name", "schema name", "logical name", "internal name"],
            "last modified by":     ["last modified by", "modified by"],
            "last modified on":     ["last modified on", "modified on", "last updated on", "updated on"]
        };

        function detectHeaderRow(sheet) {
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });
            const maxScan = Math.min(10, rows.length);
            let bestIdx = -1, bestScore = -1;
            const targets = Object.keys(HEADER_ALIASES);
            for (let i = 0; i < maxScan; i++) {
                const row = rows[i] || [];
                const fz = row.map(fuzz);
                let score = 0;
                for (const t of targets) {
                    if (fz.some(cell => HEADER_ALIASES[t].includes(cell))) score++;
                }
                if (score > bestScore) { bestScore = score; bestIdx = i; }
            }
            return { headerRowIndex: bestIdx, rows };
        }

        function buildHeaderMap(headerRowValues) {
            const map = {};
            const fz = headerRowValues.map(fuzz);
            for (let idx = 0; idx < fz.length; idx++) {
                const cell = fz[idx];
                for (const canonical of Object.keys(HEADER_ALIASES)) {
                    if (HEADER_ALIASES[canonical].includes(cell)) map[canonical] = idx;
                }
            }
            return map;
        }

        function pick(arr, idx) {
            if (idx == null || idx < 0 || idx >= arr.length) return "";
            const v = arr[idx];
            return v == null ? "" : String(v);
        }

        function parseRows(sheet, dateFormat) {
            const { headerRowIndex, rows } = detectHeaderRow(sheet);
            if (headerRowIndex < 0) throw new Error("Could not detect header row.");
            const headerRow = rows[headerRowIndex];
            const headerMap = buildHeaderMap(headerRow);
            const idxOf = (name) => headerMap[name];
            const dataRows = rows.slice(headerRowIndex + 1);

            return dataRows
                .filter(r => r && r.some(cell => String(cell || "").trim() !== ""))
                .map(r => ({
                    solutionUniqueName: norm(pick(r, idxOf("solution unique name"))),
                    relatedTable:       norm(pick(r, idxOf("related table"))),
                    componentTypeRaw:   norm(pick(r, idxOf("component type"))),
                    componentType:      normalizeType(pick(r, idxOf("component type"))),
                    displayName:        norm(pick(r, idxOf("display name"))),
                    name:               norm(pick(r, idxOf("name"))),
                    lastModifiedBy:     norm(pick(r, idxOf("last modified by"))),
                    lastModifiedOn:     formatDate(pick(r, idxOf("last modified on")), dateFormat),
                    componentStatus:    "New",
                    description:        ""
                }));
        }

        // Step navigation
        function goToStep(n) {
            document.querySelectorAll('.step-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step').forEach(s => { s.classList.remove('active', 'completed'); });
            document.getElementById(`step${n}`).classList.add('active');
            document.getElementById(`step${n}-indicator`).classList.add('active');
            for (let i = 1; i < n; i++) document.getElementById(`step${i}-indicator`).classList.add('completed');
        }

        function clearPreview() {
            document.getElementById('output').textContent = '';
            document.getElementById('preview').innerHTML = '';
            document.getElementById('generateStatus').textContent = '';
            const copyBtn = document.getElementById('copyBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            copyBtn.disabled = true; copyBtn.style.display = 'none';
            downloadBtn.disabled = true; downloadBtn.style.display = 'none';
        }

        function enableOutputButtons() {
            const copyBtn = document.getElementById('copyBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            copyBtn.disabled = false; copyBtn.style.display = 'inline-block';
            downloadBtn.disabled = false; downloadBtn.style.display = 'inline-block';
        }

        function renderGrid() {
            const tbody = document.getElementById('gridBody');
            tbody.innerHTML = '';
            componentData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="form-check-input row-select" data-index="${index}"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${ESC(row.componentType)}" data-index="${index}" data-field="componentType"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${ESC(row.relatedTable)}" data-index="${index}" data-field="relatedTable"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${ESC(row.displayName)}" data-index="${index}" data-field="displayName"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${ESC(row.name)}" data-index="${index}" data-field="name"></td>
                    <td>
                        <select class="form-select form-select-sm status-select" data-index="${index}" data-field="componentStatus">
                            <option value="New" ${row.componentStatus === 'New' ? 'selected' : ''}>New</option>
                            <option value="Modified" ${row.componentStatus === 'Modified' ? 'selected' : ''}>Modified</option>
                            <option value="Existing" ${row.componentStatus === 'Existing' ? 'selected' : ''}>Existing</option>
                            <option value="Deprecated" ${row.componentStatus === 'Deprecated' ? 'selected' : ''}>Deprecated</option>
                        </select>
                    </td>
                    <td><textarea class="form-control form-control-sm" rows="3" data-index="${index}" data-field="description" placeholder="What changed? Why? ‚úèÔ∏è">${ESC(row.description)}</textarea></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('rowCount').textContent = `${componentData.length} component(s)`;

            tbody.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const field = e.target.dataset.field;
                    componentData[index][field] = e.target.value;
                    if (field === 'componentStatus') applyStatusColor(e.target);
                });
            });
            tbody.querySelectorAll('.status-select').forEach(select => applyStatusColor(select));
        }

        function applyStatusColor(selectElement) {
            const status = selectElement.value.toLowerCase();
            selectElement.className = 'form-select form-select-sm status-select';
            if (status) selectElement.classList.add(`status-${status}`);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // HTML BUILDER
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function buildHTML(rows, solutionTitle) {
            const R = rows.map(r => ({
                solutionUniqueName: (r.solutionUniqueName || "").trim(),
                relatedTable:       (r.relatedTable || "").trim(),
                componentType:      normalizeType(r.componentType),
                displayName:        (r.displayName || "").trim(),
                name:               (r.name || "").trim(),
                lastModifiedBy:     (r.lastModifiedBy || "").trim(),
                lastModifiedOn:     (r.lastModifiedOn || "").trim(),
                componentStatus:    (r.componentStatus || "").trim(),
                description:        (r.description || "").trim()
            }));

            const title = solutionTitle || (R.find(x => x.solutionUniqueName)?.solutionUniqueName) || "Solution";
            const label = (row) => (row.displayName || row.name || "").trim();
            const bucket = (t) => R.filter(r => r.componentType === t);

            const getStatusColor = (status) => {
                const s = (status || "").toLowerCase();
                if (s === 'new')        return '#198754';
                if (s === 'modified')   return '#ffc107';
                if (s === 'existing')   return '#0d6efd';
                if (s === 'deprecated') return '#dc3545';
                return '#555555';
            };

            // Helper: render a single component <li>
            const renderComponent = (comp, prefixLabel = "") => {
                const lbl = prefixLabel ? `${prefixLabel}${ESC(label(comp))}` : ESC(label(comp));
                let result = `<li>${lbl}`;
                if (comp.componentStatus) {
                    const color = getStatusColor(comp.componentStatus);
                    result += ` <span style="color: ${color}; font-weight: bold;">- [${ESC(comp.componentStatus)}]</span>`;
                }
                if (comp.description) {
                    result += `\n<ul><li>${ESC(comp.description)}</li></ul>`;
                }
                result += `</li>\n`;
                return result;
            };

            // Helper: render a sub-group of entity-level items
            const renderSubGroup = (groupLabel, items, indent = "          ") => {
                if (!items.length) return "";
                let html = `${indent}<li><strong>${groupLabel}</strong>\n${indent}  <ul>\n`;
                for (const item of items) {
                    html += `${indent}    ${renderComponent(item)}`;
                }
                html += `${indent}  </ul>\n${indent}</li>\n`;
                return html;
            };

            // ‚îÄ‚îÄ Determine which rows are entity-level vs global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // A row is "entity-level" when its componentType belongs to ENTITY_LEVEL_TYPES
            // AND it has a relatedTable value (for Types that always go under an entity)
            // Business Rules, Forms, Views, Charts, Keys, Relationships, Hierarchy Settings
            // are all entity-scoped even if relatedTable happens to be blank in the sheet.

            const ALWAYS_ENTITY_TYPES = new Set([
                "Column", "Form", "Main Form", "Quick Create Form", "Quick View Form",
                "View", "Chart", "Key", "Relationship", "Business Rule", "Hierarchy Setting", "Dashboard (Entity)"
            ]);

            // Rows explicitly attached to a Table (relatedTable set)
            const entityLevelRows = R.filter(r =>
                ALWAYS_ENTITY_TYPES.has(r.componentType) ||
                (r.componentType === "Table" && r.relatedTable)
            );

            // All distinct entities referenced
            const allEntityNames = Array.from(new Set([
                ...R.filter(r => r.componentType === "Table").map(r => r.relatedTable || r.displayName || r.name),
                ...entityLevelRows.filter(r => r.relatedTable).map(r => r.relatedTable)
            ])).filter(Boolean);

            // Global-scope buckets
            const canvasApps       = bucket("Canvas App");
            const cloudFlows       = bucket("Cloud Flow");
            const customControls   = bucket("Custom Control");
            const modelDrivenApps  = bucket("Model-Driven App");
            const pluginAssemblies = bucket("Plugin Assembly");
            const pluginSteps      = bucket("Plugin Step");
            const securityRoles    = bucket("Security Role");
            const webResources     = bucket("Web Resource");
            const envVarDefs       = bucket("Environment Variable Definition");
            const emailTemplates   = bucket("Email Template");
            const bpfs             = bucket("Business Process Flow");
            const dashboards       = bucket("Dashboard");
            const charts_global    = bucket("Chart").filter(r => !r.relatedTable); // global charts without entity
            const sitemaps         = bucket("Sitemap");
            const connections      = bucket("Connection Reference");
            const choices          = bucket("Choice");
            const azureFunctions   = bucket("Azure Function");
            const logicApps        = bucket("Azure Logic App");
            const azureResources   = bucket("Azure Resource");

            // Link Plugin Steps to Assemblies
            const stepsByAssembly = new Map();
            for (const asm of pluginAssemblies) {
                stepsByAssembly.set((asm.name || asm.displayName || "").toLowerCase(), []);
            }
            const unlinkedSteps = [];
            for (const step of pluginSteps) {
                const sname = (step.name || step.displayName || "").toLowerCase();
                let linked = false;
                for (const [k, arr] of stepsByAssembly.entries()) {
                    if (k && sname.includes(k)) { arr.push(step); linked = true; break; }
                }
                if (!linked) unlinkedSteps.push(step);
            }

            // ‚îÄ‚îÄ Build output ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let html = `<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>${ESC(title)}</title>\n</head>\n<body>\n`;
            html += `<p><strong>${ESC(title)}</strong></p>\n`;
            html += `<p><strong>Release Components</strong></p>\n`;
            html += `<ul>\n`;

            // ‚îÄ‚îÄ 1. Entity Components ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (allEntityNames.length > 0) {
                for (const entity of allEntityNames) {
                    // Find the Table row for this entity (by relatedTable or by name)
                    const tableRow = R.find(r => r.componentType === "Table" &&
                        (r.relatedTable === entity || r.displayName === entity || r.name === entity));

                    // All entity-scoped rows for this entity
                    const byEntity = (type) => R.filter(r => r.componentType === type && r.relatedTable === entity);
                    const byEntityLoose = (type) => R.filter(r => r.componentType === type &&
                        (r.relatedTable === entity || (!r.relatedTable && r.displayName === entity)));

                    const columns         = byEntity("Column");
                    const forms           = [
                        ...byEntity("Form"), ...byEntity("Main Form"),
                        ...byEntity("Quick Create Form"), ...byEntity("Quick View Form")
                    ];
                    const views           = byEntity("View");
                    const entityCharts    = byEntity("Chart");
                    const keys            = byEntity("Key");
                    const relationships   = byEntity("Relationship");
                    const businessRules   = byEntity("Business Rule");
                    const hierarchySettings = byEntity("Hierarchy Setting");
                    const entityDashboards  = byEntity("Dashboard (Entity)");

                    html += `  <li><strong>Entity Component</strong>\n`;
                    html += `    <ul>\n`;

                    // Table header line
                    html += `      <li><strong>Table - ${ESC(entity)}</strong>`;
                    if (tableRow?.componentStatus) {
                        const color = getStatusColor(tableRow.componentStatus);
                        html += ` <span style="color: ${color}; font-weight: bold;">- [${ESC(tableRow.componentStatus)}]</span>`;
                    }
                    if (tableRow?.description) {
                        html += `\n        <ul><li>${ESC(tableRow.description)}</li></ul>`;
                    }

                    // ‚îÄ‚îÄ Columns (grouped by status) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (columns.length > 0) {
                        const newCols      = columns.filter(c => c.componentStatus === "New");
                        const modifiedCols = columns.filter(c => c.componentStatus === "Modified");
                        const existingCols = columns.filter(c => c.componentStatus === "Existing");
                        const deprecatedCols = columns.filter(c => c.componentStatus === "Deprecated");
                        const otherCols    = columns.filter(c => !["New","Modified","Existing","Deprecated"].includes(c.componentStatus));

                        html += `\n        <ul>\n`;
                        if (newCols.length)       html += renderSubGroup("New Attributes List", newCols, "          ");
                        if (modifiedCols.length)  html += renderSubGroup("Modified Attributes", modifiedCols, "          ");
                        if (existingCols.length)  html += renderSubGroup("Existing Attributes", existingCols, "          ");
                        if (deprecatedCols.length) html += renderSubGroup("Deprecated Attributes", deprecatedCols, "          ");
                        if (otherCols.length)     html += renderSubGroup("Attributes", otherCols, "          ");
                        html += `        </ul>`;
                    }

                    // ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (forms.length > 0) {
                        html += `\n        <ul>\n`;
                        html += renderSubGroup("Forms", forms, "          ");
                        html += `        </ul>`;
                    }

                    // ‚îÄ‚îÄ Views ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (views.length > 0) {
                        html += `\n        <ul>\n`;
                        html += renderSubGroup("Views", views, "          ");
                        html += `        </ul>`;
                    }

                    // ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (entityCharts.length > 0) {
                        html += `\n        <ul>\n`;
                        html += renderSubGroup("Charts", entityCharts, "          ");
                        html += `        </ul>`;
                    }

                    // ‚îÄ‚îÄ Business Rules ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (businessRules.length > 0) {
                        html += `\n        <ul>\n`;
                        html += renderSubGroup("Business Rules", businessRules, "          ");
                        html += `        </ul>`;
                    }

                    // ‚îÄ‚îÄ Keys ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (keys.length > 0) {
                        html += `\n        <ul>\n`;
                        html += renderSubGroup("Keys", keys, "          ");
                        html += `        </ul>`;
                    }

                    // ‚îÄ‚îÄ Relationships ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (relationships.length > 0) {
                        html += `\n        <ul>\n`;
                        html += renderSubGroup("Relationships", relationships, "          ");
                        html += `        </ul>`;
                    }

                    // ‚îÄ‚îÄ Hierarchy Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (hierarchySettings.length > 0) {
                        html += `\n        <ul>\n`;
                        html += renderSubGroup("Hierarchy Settings", hierarchySettings, "          ");
                        html += `        </ul>`;
                    }

                    // ‚îÄ‚îÄ Entity Dashboards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (entityDashboards.length > 0) {
                        html += `\n        <ul>\n`;
                        html += renderSubGroup("Dashboards", entityDashboards, "          ");
                        html += `        </ul>`;
                    }

                    html += `\n      </li>\n`;
                    html += `    </ul>\n`;
                    html += `  </li>\n`;
                }
            }

            // ‚îÄ‚îÄ 2. Cloud Flows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (cloudFlows.length > 0) {
                html += `  <li><strong>Cloud Flow</strong>\n    <ul>\n`;
                for (const f of cloudFlows) html += `      ${renderComponent(f)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 3. Canvas Apps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (canvasApps.length > 0) {
                html += `  <li><strong>Canvas App</strong>\n    <ul>\n`;
                for (const c of canvasApps) html += `      ${renderComponent(c)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 4. Model-Driven Apps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (modelDrivenApps.length > 0) {
                html += `  <li><strong>Model-Driven App</strong>\n    <ul>\n`;
                for (const m of modelDrivenApps) html += `      ${renderComponent(m)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 5. Business Process Flows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (bpfs.length > 0) {
                html += `  <li><strong>Business Process Flow</strong>\n    <ul>\n`;
                for (const b of bpfs) html += `      ${renderComponent(b)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 6. Global Dashboards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (dashboards.length > 0) {
                html += `  <li><strong>Dashboard</strong>\n    <ul>\n`;
                for (const d of dashboards) html += `      ${renderComponent(d)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 7. Sitemaps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (sitemaps.length > 0) {
                html += `  <li><strong>Sitemap</strong>\n    <ul>\n`;
                for (const s of sitemaps) html += `      ${renderComponent(s)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 8. Plugin Assemblies + Steps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (pluginAssemblies.length > 0 || unlinkedSteps.length > 0) {
                for (const asm of pluginAssemblies) {
                    const key = (asm.name || asm.displayName || "").toLowerCase();
                    const steps = stepsByAssembly.get(key) || [];
                    html += `  <li><strong>Plugin Assembly - ${ESC(label(asm))}</strong>`;
                    if (asm.componentStatus) {
                        const color = getStatusColor(asm.componentStatus);
                        html += ` <span style="color: ${color}; font-weight: bold;">- [${ESC(asm.componentStatus)}]</span>`;
                    }
                    if (asm.description) html += `\n    <ul><li>${ESC(asm.description)}</li></ul>`;
                    if (steps.length) {
                        html += `\n    <ul>\n`;
                        for (const s of steps) html += `      ${renderComponent(s, "Plugin Step - ")}`;
                        html += `    </ul>`;
                    }
                    html += `\n  </li>\n`;
                }
                if (unlinkedSteps.length > 0) {
                    html += `  <li><strong>Plugin Step</strong>\n    <ul>\n`;
                    for (const s of unlinkedSteps) html += `      ${renderComponent(s)}`;
                    html += `    </ul>\n  </li>\n`;
                }
            }

            // ‚îÄ‚îÄ 9. Security Roles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (securityRoles.length > 0) {
                html += `  <li><strong>Security Role</strong>\n    <ul>\n`;
                for (const s of securityRoles) html += `      ${renderComponent(s)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 10. Web Resources ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (webResources.length > 0) {
                html += `  <li><strong>Web Resource</strong>\n    <ul>\n`;
                for (const w of webResources) html += `      ${renderComponent(w)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 11. Custom Controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (customControls.length > 0) {
                html += `  <li><strong>Custom Control</strong>\n    <ul>\n`;
                for (const c of customControls) html += `      ${renderComponent(c)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 12. Environment Variables ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (envVarDefs.length > 0) {
                html += `  <li><strong>Environment Variable Definition</strong>\n    <ul>\n`;
                for (const e of envVarDefs) html += `      ${renderComponent(e)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 13. Connection References ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (connections.length > 0) {
                html += `  <li><strong>Connection Reference</strong>\n    <ul>\n`;
                for (const c of connections) html += `      ${renderComponent(c)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 14. Choices ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (choices.length > 0) {
                html += `  <li><strong>Choice - Global</strong>\n    <ul>\n`;
                for (const c of choices) html += `      ${renderComponent(c)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 15. Email Templates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (emailTemplates.length > 0) {
                html += `  <li><strong>Email Template</strong>\n    <ul>\n`;
                for (const e of emailTemplates) html += `      ${renderComponent(e)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 16. Azure Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (azureFunctions.length > 0) {
                html += `  <li><strong>Azure Function</strong>\n    <ul>\n`;
                for (const a of azureFunctions) html += `      ${renderComponent(a)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 17. Logic Apps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (logicApps.length > 0) {
                html += `  <li><strong>Azure Logic App</strong>\n    <ul>\n`;
                for (const l of logicApps) html += `      ${renderComponent(l)}`;
                html += `    </ul>\n  </li>\n`;
            }

            // ‚îÄ‚îÄ 18. Other Azure Resources ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (azureResources.length > 0) {
                html += `  <li><strong>Azure Resource</strong>\n    <ul>\n`;
                for (const a of azureResources) html += `      ${renderComponent(a)}`;
                html += `    </ul>\n  </li>\n`;
            }

            html += `</ul>\n<p>&nbsp;</p>\n</body>\n</html>`;
            return html;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // EVENT LISTENERS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.addEventListener("DOMContentLoaded", () => {

            document.getElementById("loadBtn").addEventListener("click", async () => {
                const file = document.getElementById("fileInput").files?.[0];
                const statusEl = document.getElementById("loadStatus");
                if (!file) { statusEl.textContent = "Please select an Excel file."; statusEl.className = 'small text-danger'; return; }
                if (!window.XLSX) { statusEl.textContent = "SheetJS not loaded."; statusEl.className = 'small text-danger'; return; }
                statusEl.textContent = "Loading Excel file..."; statusEl.className = 'small loading';
                try {
                    const data = await file.arrayBuffer();
                    const wb = XLSX.read(data, { type: "array" });
                    const sheetName = wb.SheetNames[0];
                    const ws = wb.Sheets[sheetName];
                    if (!ws) throw new Error(`Sheet '${sheetName}' not found.`);
                    const solutionCellAddr = (document.getElementById("solutionCell").value || "B1").trim();
                    solutionName = getCell(ws, solutionCellAddr) || "Solution";
                    componentData = parseRows(ws, "DD/MM/YYYY HH:mm");
                    statusEl.textContent = `‚úÖ Loaded ${componentData.length} component(s) from '${sheetName}'`;
                    statusEl.className = 'small text-success';
                    renderGrid();
                    setTimeout(() => goToStep(2), 500);
                } catch (e) {
                    console.error(e);
                    statusEl.textContent = `‚ùå Error: ${e.message}`;
                    statusEl.className = 'small text-danger';
                }
            });

            document.getElementById("backToUploadBtn").addEventListener("click", () => goToStep(1));
            document.getElementById("proceedToGenerateBtn").addEventListener("click", () => goToStep(3));
            document.getElementById("backToEditBtn").addEventListener("click", () => { clearPreview(); goToStep(2); });

            document.getElementById("selectAll").addEventListener("change", (e) => {
                document.querySelectorAll('.row-select').forEach(cb => cb.checked = e.target.checked);
            });

            document.getElementById("addRowBtn").addEventListener("click", () => {
                componentData.push({ solutionUniqueName: solutionName, relatedTable: "", componentTypeRaw: "", componentType: "", displayName: "", name: "", lastModifiedBy: "", lastModifiedOn: "", componentStatus: "New", description: "" });
                renderGrid();
            });

            document.getElementById("removeSelectedBtn").addEventListener("click", () => {
                const selected = Array.from(document.querySelectorAll('.row-select:checked'))
                    .map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
                selected.forEach(index => componentData.splice(index, 1));
                document.getElementById("selectAll").checked = false;
                renderGrid();
            });

            document.getElementById("generateBtn").addEventListener("click", () => {
                const statusEl = document.getElementById("generateStatus");
                statusEl.textContent = "Generating HTML..."; statusEl.className = 'small loading';
                try {
                    const html = buildHTML(componentData, solutionName);
                    document.getElementById("output").textContent = html;
                    document.getElementById("preview").innerHTML = html;
                    statusEl.textContent = `‚úÖ Generated HTML for ${componentData.length} component(s)`;
                    statusEl.className = 'small text-success';
                    enableOutputButtons();
                } catch (e) {
                    console.error(e);
                    statusEl.textContent = `‚ùå Error: ${e.message}`;
                    statusEl.className = 'small text-danger';
                }
            });

            document.getElementById("copyBtn").addEventListener("click", async () => {
                const statusEl = document.getElementById("generateStatus");
                const htmlContent = document.getElementById("output").textContent || "";
                if (!htmlContent) { statusEl.textContent = "‚ö†Ô∏è Please generate HTML first!"; statusEl.className = 'small text-danger'; return; }
                try {
                    await navigator.clipboard.writeText(htmlContent);
                    statusEl.textContent = "‚úÖ HTML copied to clipboard!"; statusEl.className = 'small text-success';
                } catch (e) {
                    statusEl.textContent = "‚ùå Failed to copy to clipboard."; statusEl.className = 'small text-danger';
                }
            });

            document.getElementById("downloadBtn").addEventListener("click", () => {
                const statusEl = document.getElementById("generateStatus");
                const text = document.getElementById("output").textContent || "";
                if (!text) { statusEl.textContent = "‚ö†Ô∏è Please generate HTML first!"; statusEl.className = 'small text-danger'; return; }
                const blob = new Blob([text], { type: "text/html;charset=utf-8" });
                const a = document.createElement("a");
                const filename = `${solutionName.replace(/[^a-z0-9]/gi, '_')}_Release.html`;
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(a.href);
                a.remove();
                statusEl.textContent = `‚úÖ Downloaded: ${filename}`; statusEl.className = 'small text-success';
            });
        });
    </script>
</body>
</html>
